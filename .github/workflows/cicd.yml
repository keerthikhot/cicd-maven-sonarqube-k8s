name: CI-CD Maven App to Local Minikube

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: self-hosted   # MUST be self-hosted (your Mac)

    steps:
      # -----------------------------
      # Checkout source code
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Setup Java 11
      # -----------------------------
      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 11

      # -----------------------------
      # Maven Build
      # -----------------------------
      - name: Build Maven Application
        working-directory: app
        run: mvn clean package -DskipTests

      # -----------------------------
      # SonarQube Scan
      # -----------------------------
      - name: SonarQube Analysis
        working-directory: app
        run: |
          mvn sonar:sonar \
            -Dsonar.projectKey=demo-app \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      # -----------------------------
      # Switch Docker to Minikube
      # -----------------------------
      - name: Configure Docker for Minikube
        run: |
          eval $(minikube docker-env)

      # -----------------------------
      # Build Docker Image (LOCAL)
      # -----------------------------
      - name: Build Docker Image
        run: |
          docker build -t maven-app:latest ./app

      # -----------------------------
      # Deploy Application
      # -----------------------------
      - name: Deploy App to Minikube
        run: |
          kubectl apply -f k8s/app/deployment.yaml
          kubectl apply -f k8s/app/service.yaml

      # -----------------------------
      # Deploy Prometheus
      # -----------------------------
      - name: Deploy Prometheus
        run: |
          kubectl apply -f k8s/prometheus/

      # -----------------------------
      # Deploy Grafana
      # -----------------------------
      - name: Deploy Grafana
        run: |
          kubectl apply -f k8s/grafana/

